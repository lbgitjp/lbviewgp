!function(t){var e={};function n(o){if(e[o])return e[o].exports;var r=e[o]={i:o,l:!1,exports:{}};return t[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(o,r,function(e){return t[e]}.bind(null,r));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";n.r(e);const o=1,r=2,s=3;let i,c=0;function a(){return c===s}function l(){return c===r}function u(t){i=t}function f(){return i}let h,p=self;function d(t){h=null;try{t.__RealObject}catch(t){console.log("getRealObject err: "+t),h||console.warn("getRealObject __PMTarget return null.")}return h||t}let g={get:function(t,e,n){if("postMessage"===e)return function(e,n){return void 0!==n&&(arguments[1]="*"),Reflect.apply(t.postMessage,t,arguments)};if("__RealObject"===e)return h=t,!0;{let n=t[e];if(n){let e=typeof n;"object"!==e&&"function"!==e||"bind"in n&&(n=n.bind(t))}return n}}};const w=new WeakMap;function m(t){if(!t)return t;let e=w.get(t);return e||(e=new Proxy(t,g),w.set(t,e)),e}const y=1,b=2,_=3,v=4,k=110,E=111,x=112,S=112,L=113,R=200,O=201;new TextEncoder;const P=/^(?:\d+\.){0,3}\d+$/;const M=new Set(["text/javascript","application/javascript","application/ecmascript","application/x-ecmascript","module"]);function j(t){let e=0;for(let n=0,o=t.length;n<o;n++)e=31*e+t.charCodeAt(n)>>>0;return e}function T(){return Date.now()/1e3|0}const $=function(){const t=p.__PATH__;if(t)return t;let e=location.href;const n=e.indexOf("/-----http");e=-1===n?e.replace(/[^/]+$/,""):e.substr(0,n);return e.replace(/\/*$/,"/")}(),N=$+"index.html",D=$+"conf.js",A=$+"favicon.ico",I=$+"__sys__/helper.js",W=$+"__sys__/assets/",C=$+"-----";const H=C,U=H.length,F=$.length;function q(t){return/^https?:/.test(t)}function B(t,e){try{return e?new URL(t,e):new URL(t)}catch(t){}}function G(t){const e=t.href;return!q(n=e)||n.startsWith(H)?e:H+e;var n}function J(t,e){let n;if(a())n=e;else{n=f().href}const o=B(t,n);return o?G(o):t}function K(t){const e=t.href;return e.startsWith(H)?e.substr(U):e}function V(t){const e=B(t);return e?K(e):t}function Y(t){const e=t.indexOf("#");return-1===e?t:t.substr(0,e)}function z(t,e){return t.replace(/(;\s*url=)(.+)/i,(t,n,o)=>n+J(o,e))}const X={"www.google.com":["google","gg","g"],"www.youtube.com":["youtube","yt","y"],"www.wikipedia.org":["wikipedia","wiki","wk","w"],"www.facebook.com":["facebook","fb","f"],"twitter.com":["twitter","tw","t"]},Q="https://www.google.com/search?q=%s";let Z,tt,et;function nt(t){const e=q(t)?t:`http://${t}`,n=B(e);if(!n)return;const{hostname:o}=n;var r;if(o.includes(".")&&(r=o,!P.test(r)||e.includes(o)))return n.href}function ot(t){const e=t.substr(U),n=B(e);if(n){const o=e.match(/\/-----(https?:\/\/.+)$/);if(o)return H+o[1];if(q(n.protocol)&&H+n.href===t)return}const o=t.substr(F).replace(/^-*/,""),r=function(t){if(!Z){Z=new Map;for(const[t,e]of Object.entries(X))for(const n of e)Z.set(n,t)}const e=Z.get(t);if(e)return"https://"+e+"/"}(o)||nt(o);if(r)return H+r;const s=o.replace(/&/g,"%26");return H+Q.replace("%s",s)}function rt(t,e){let n=0;for(const{weight:o,host:r}of et[e])if((n+=o)>t)return r}function st(t,e){let n="s";if(function(t){return/^(localhost|127\.\d+\.\d+\.\d+)([:/]|$)/.test(t)}(t)){n="";let e=new URL(p.location.href);e.host===t&&"https:"===e.protocol&&(n="s")}return`${e}${n}://${t}/${e}`}function it(t,e){let n=tt.node_default;return 2===e&&(n=tt.node_acc),rt(t,n)}function ct(t,e){let n="https";switch(t.protocol){case"wss:":break;case"ws:":n="http";break;default:return null}const o=function(t){const e=t.indexOf("://");return-1===e?t:t.substr(e+3)}(Y(t.href));let r;if(e.url__=n+"://"+o,tt){r=rt(j(t.href),tt.node_default)}else r=p.location.host;return st(r,"ws")+"?"+new URLSearchParams(e)}function at(t){tt=t,et={};for(const[e,n]of Object.entries(t.node_map)){const t=[];let o=0;for(const[e,r]of Object.entries(n.lines))o+=r,t.push({host:e,weight:r});for(const e of t)e.weight=e.weight/o*4294967295>>>0;t.sort((t,e)=>e.weight-t.weight),et[e]=t}}const{getOwnPropertyDescriptor:lt,defineProperty:ut,apply:ft}=Reflect,ht={};function pt(t,e,n){const o=t[e];if(!o)return!1;const r=n(o);Object.keys(o).forEach(t=>{r[t]=o[t]});const s=o.prototype;return s&&(r.prototype=s),t[e]=r,!0}function dt(t,e,n,o){const r=lt(t,e);return!!r&&(n&&pt(r,"get",n),o&&pt(r,"set",o),ut(t,e,r),!0)}function gt(t){function e(t,e,n,o){dt(t,e,t=>(function(){const e=t.call(this);return n.call(this,e)}),t=>(function(e){(e=o.call(this,e))!==ht&&t.call(this,e)}))}const n=t.Element.prototype,o=n.getAttribute,r=n.setAttribute,s={},i={},c={},a={};return{attr:function(t,n,...o){let r,l,u;o.forEach(o=>{const f=o.name.replace(/-(\w)/g,(t,e)=>e.toUpperCase());if(e(n,f,o.onget,o.onset),"innerText"===f)return void(i[t]=o);s[t]?s[t].push(o):(r=!0,s[t]=[o],c[t]={},a[t]={}),l||(l=c[t],u=a[t]);const h=o.name.toLocaleLowerCase();l[h]=o.onset,u[h]=o.onget}),r&&(pt(n,"getAttribute",t=>(function(e){const n=(e+"").toLocaleLowerCase(),o=u[n];if(!o)return ft(t,this,arguments);const r=ft(t,this,arguments);return o.call(this,r)})),pt(n,"setAttribute",t=>(function(e,n){const o=(e+"").toLocaleLowerCase(),r=l[o];if(r){const t=r.call(this,n);if(t===ht)return;arguments[1]=t}return ft(t,this,arguments)})))},addNode:function(t){const e=t.nodeType;if(1===e){const e=t,n=s[e.tagName];n&&n.forEach(t=>{!function(t,e){const n=e.name;if(!t.hasAttribute(n))return;const s=o.call(t,n),i=e.onset.call(t,s,!0);i!==ht&&r.call(t,n,i)}(e,t)})}else if(3===e){const e=t.parentElement;if(e){const n=i[e.tagName];n&&function(t,e,n){const o=t.nodeValue,r=e.onset.call(n,o,!0);r!==ht&&(t.nodeValue=r)}(t,n,e)}}},delNode:function(t){}}}class wt{constructor(){this._promise=new Promise((t,e)=>{this._resolve=t,this._reject=e})}wait(){return this._promise}notify(t){this._resolve(t)}abort(t){this._reject(t)}}class mt{constructor(t){this._name=t,this._db=null}_getStore(t,e){return this._db.transaction(t,e).objectStore(t)}open(t){const e=new wt,n=indexedDB.open(this._name);return n.onsuccess=o=>{const r=n.result;this._db=r,r.onclose=e=>{console.warn("[lbview] indexedDB disconnected, reopen..."),this.open(t)},e.notify()},n.onerror=t=>{console.warn("req.onerror:",t),e.abort(n.error)},n.onupgradeneeded=e=>{const o=n.result;for(const[e,n]of Object.entries(t))o.createObjectStore(e,n)},e.wait()}close(){this._db.close()}get(t,e){const n=new wt,o=this._getStore(t,"readonly").get(e);return o.onsuccess=t=>{n.notify(o.result)},o.onerror=t=>{n.abort(o.error)},n.wait()}put(t,e){const n=new wt,o=this._getStore(t,"readwrite").put(e);return o.onsuccess=t=>{n.notify()},o.onerror=t=>{n.abort(o.error)},n.wait()}delete(t,e){const n=new wt,o=this._getStore(t,"readwrite").delete(e);return o.onsuccess=t=>{n.notify()},o.onerror=t=>{n.abort(o.error)},n.wait()}enum(t,e,...n){const o=new wt,r=this._getStore(t,"readonly").openCursor(...n);return r.onsuccess=t=>{const{result:n}=r;n?!1!==e(n.value)&&n.continue():o.notify()},r.onerror=t=>{o.abort(r.error)},o.wait()}}let yt=new Set;function bt(){this.id="",this.name="",this.value="",this.domain="",this.hostOnly=!1,this.path="",this.expires=NaN,this.isExpired=!1,this.secure=!1,this.httpOnly=!1,this.sameSite=""}function _t(t,e){const n=t.expires;return!isNaN(n)&&n<e}class vt{constructor(){this.items=null,this.children={}}nextChild(t){return this.children[t]||(this.children[t]=new vt)}getChild(t){return this.children[t]}addCookie(t){this.items?this.items.push(t):this.items=[t]}}const kt=new Map,Et=new vt;function xt(){const t=[];for(const e of kt.values())e.httpOnly||t.push(e);return t}function St(t,e,n){const o=new bt,r=t.split(";");for(let t=0;t<r.length;t++){let e,s;const i=r[t].trim(),c=i.indexOf("=");if(-1!==c?(e=i.substr(0,c),s=i.substr(c+1)):(e=0===t?"":i,s=0===t?i:""),0!==t)switch(e.toLocaleLowerCase()){case"expires":isNaN(o.expires)&&(o.expires=Date.parse(s));break;case"domain":"."===s[0]&&(s=s.substr(1)),o.domain=s;break;case"path":o.path=s;break;case"httponly":o.httpOnly=!0;break;case"secure":o.secure=!0;break;case"max-age":o.expires=n+1e3*+s;break;case"samesite":o.sameSite=s}else o.name=e,o.value=s}if(_t(o,n)&&(o.isExpired=!0),o.name.startsWith("__Secure-")&&("https:"!==e.protocol||!o.secure))return;if(o.name.startsWith("__Host-")&&("https:"!==e.protocol||!o.secure||""!==o.domain||"/"!==o.path))return;if(o.secure&&"http:"===e.protocol)return;const s=e.hostname;o.domain=s,o.hostOnly=!0;const i=e.pathname;return o.path=i,o.id=(o.secure?";":"")+o.name+";"+o.domain+o.path,o}function Lt(t){const e=t.id,n=kt.get(e);if(n)t.isExpired?(kt.delete(e),n.isExpired=!0):(r=t,(o=n).id=r.id,o.name=r.name,o.value=r.value,o.domain=r.domain,o.hostOnly=r.hostOnly,o.path=r.path,o.expires=r.expires,o.isExpired=r.isExpired,o.secure=r.secure,o.httpOnly=r.httpOnly,o.sameSite=r.sameSite),yt.add(n);else{const n=t.domain.split(".");let o=n.length,r=Et;do{r=r.nextChild(n[--o])}while(0!==o);r.addCookie(t),kt.set(e,t),yt.add(t)}var o,r}function Rt(t){const e=[],n=Date.now(),o=t.hostname,r=t.pathname,s="https:"===t.protocol,i=o.split(".");let c=i.length,a=Et;do{if(!(a=a.getChild(i[--c])))break;const t=a.items;if(t)for(let o=0;o<t.length;o++){const i=t[o];if(!s&&i.secure)continue;if(i.hostOnly&&0!==c)continue;if(l=i.path,(u=r)!==l&&(l.endsWith("/")||(l+="/"),!u.startsWith(l)))continue;if(i.isExpired)continue;if(_t(i,n)){i.isExpired=!0;continue}let a=i.value;i.name&&(a=i.name+"="+a),e.push(a)}}while(0!==c);var l,u;return e.join("; ")}let Ot,Pt;async function Mt(){if(0===yt.size)return;const t=yt;yt=new Set;for(const e of t)e.isExpired?await Ot.delete("cookie",e.id):isNaN(e.expires)||await Ot.put("cookie",e)}const jt=" ".repeat(500);function Tt(t,e){let n=0;return t=(t=t.replace(/(?<=\b|=)(([\w$]+\([\w,$]*?\)\.|[\w$]+\.)+)location\b(?!\s*(:|=))/g,(t,e)=>(n++,"__LocationF("+(e||"")+"location)"))).replace(/(?<=\s|=|;)location\.(?!\s*(:|=))/g,(t,e)=>(n++,"__LocationF(location).")),console.log("code location replace "+n+" times, href: "+(e||"")),n=0,t=(t=t.replace(/(?<=(?:!|=)=\s*)\b((\w+\([\w,]*?\)\.|\w+\.)+)parent\b(?!\s*\.)/g,(t,e)=>(n++,"__ParentF("+(e||"")+"parent)"))).replace(/\b((\w+\([\w,]*?\)\.|\w+\.)+)parent\b(?=\s*(?:!|=)=)/g,(t,e)=>(n++,"__ParentF("+(e||"")+"parent)")),console.log("code parent replace "+n+" times, href: "+(e||"")),t}function $t(t,e,n){return function(t,e){const n=C+t.origin+"/favicon.ico",o=Pt.inject_html||"";return`\x3c!-- JS PROXY HELPER --\x3e\n<!doctype html>\n<base href="${t.href}">\n<link rel="icon" href="${n}" type="image/x-icon">\n<script data-id="${e}" src="${I}"><\/script>\n${o}\n\x3c!-- PADDING ${jt} --\x3e\n\n`}(e,n)+t.replace(/\s+(integrity\s*\=\s*["'].*?["'])\s+/g,(t,e)=>" ").replace(/<meta\s+http-equiv\s*=\s*["']content-type["'].*?>/gi,(t,e)=>' <meta http-equiv="content-type" content="text/html; charset=utf-8"> ')}const{defineProperty:Nt,setPrototypeOf:Dt}=Object;function At(t,e){Nt(t,"__location",{get:()=>e,set(n){console.log("[lbview] %s set location: %s",t,n),e.href=n}})}const{apply:It,defineProperty:Wt,ownKeys:Ct,getOwnPropertyDescriptor:Ht}=Reflect,Ut=void 0;function Ft(t,e,n){const o=t[e];if(!o)return;const r=n.length,s={getItem:i,setItem:c,removeItem:a,clear:function(){l().forEach(a)},key:function(t){const e=l()[0|t];if(e===Ut)return null;return e},constructor:o.constructor,toString:()=>o.toString(),[Symbol.toStringTag]:"Storage",get length(){return l().length}};function i(t){return o.getItem(n+t)}function c(t,e){o.setItem(n+t,e)}function a(t){return o.removeItem(n+t)}function l(){const t=[],e=Ct(o);for(let o=0;o<e.length;o++){const s=e[o];"string"==typeof s&&(s.startsWith(n)&&t.push(s.substr(r)))}return t}const u=new Proxy(o,{get(t,n){const o=s[n];if(o!==Ut)return o;console.log("[lbview] %s get: %s",e,n);const r=i(n);return null===r?Ut:r},set(t,n,o){if(!(n in s))return console.log("[lbview] %s set: %s = %s",e,n,o),c(n,o),!0;s[n]=o},deleteProperty:(t,n)=>(console.log("[lbview] %s del: %s",e,n),a(n),!0),has:(t,o)=>(console.log("[lbview] %s has: %s",e,o),"string"==typeof o&&n+o in t),ownKeys:t=>l(),getOwnPropertyDescriptor(t,e){if("string"==typeof e)return Reflect.getOwnPropertyDescriptor(o,n+e)}});Wt(t,e,{value:u})}const qt=p,{apply:Bt,construct:Gt}=Reflect;function Jt(){l()&&u(new URL(V(qt.location.href))),function(t){const e=f().origin+"$",n=e.length;function o(t){return t.substr(n)}function r(t){return function(){const e=t.call(this);return e&&o(e)}}if(Ft(t,"localStorage",e),Ft(t,"sessionStorage",e),t.StorageEvent){const e=t.StorageEvent.prototype;dt(e,"key",r),dt(e,"url",t=>(function(){return V(t.call(this))}))}function s(t){return function(n){return arguments.length>0&&(arguments[0]=e+n),It(t,this,arguments)}}const i=t.IDBFactory.prototype;pt(i,"open",s),pt(i,"databases",t=>(async function(){const e=await It(t,this,arguments),n=[];for(const t of e)"."!==t.name[0]&&(t.name=o(t.name),n.push(t));return n})),pt(i,"deleteDatabase",s),dt(t.IDBDatabase.prototype,"name",r);const c=t.CacheStorage.prototype;pt(c,"open",s),pt(c,"keys",t=>(async function(){const e=await It(t,this,arguments),n=[];for(const t of e)"."!==t[0]&&n.push(o(t));return n})),pt(c,"delete",s),pt(t,"openDatabase",s)}(qt);!function(t){const e=t.location;let n;function o(t){return new URL(K(t))}const r={get href(){return o(e).href},get protocol(){return o(e).protocol},get host(){return o(e).host},get hostname(){return o(e).hostname},get port(){return o(e).port},get pathname(){return o(e).pathname},get search(){return o(e).search},get hash(){return o(e).hash},get origin(){return o(e).origin},toString(){return this.href},toLocaleString(){return this.href},get ancestorOrigins(){if(!n){n=[];let e=t;for(;(e=d(e.parent))!==top;){const t=o(e.location);n.unshift(t.origin)}}return n},set href(t){console.log("[lbview] set location.href:",t),e.href=J(t,this)},set protocol(t){console.log("[lbview] set location.protocol:",t);const n=o(e);n.href=t,e.href=G(n)},set host(t){console.log("[lbview] set location.host:",t);const n=o(e);n.host=t,e.href=G(n)},set hostname(t){console.log("[lbview] set location.hostname:",t);const n=o(e);n.hostname=t,e.href=G(n)},set port(t){console.log("[lbview] set location.port:",t);const n=o(e);n.port=t,e.href=G(n)},set pathname(t){console.log("[lbview] set location.pathname:",t);const n=o(e);n.pathname=t,e.href=G(n)},set search(t){e.search=t},set hash(t){e.hash=t},reload(){return console.warn("[lbview] location.reload"),e.reload(...arguments)},replace(t){return t&&(console.warn("[lbview] location.replace:",t),arguments[0]=J(t,this)),e.replace(...arguments)},assign(t){return t&&(console.warn("[lbview] location.assign:",t),arguments[0]=J(t,this)),e.assign(...arguments)}},s=e.constructor.prototype,i=Dt(r,s);At(t,i),t.__LocationF=function(e){return e===t.location?t.__location:e};const c=t.Document;c&&At(c.prototype,i)}(qt);function t(t){pt(qt,t,e=>(function(n){return n&&(console.log("[lbview] new %s: %s",t,n),arguments[0]=J(n,this)),Gt(e,arguments)}))}dt(qt.PerformanceEntry.prototype,"name",t=>(function(){const e=t.call(this);return/^https?:/.test(e)?V(e):e})),pt(qt,"WebSocket",t=>(function(e){const n=B(e);if(n){const t={};arguments[0]=ct(n,t)}return Gt(t,arguments)})),t("Worker"),t("SharedWorker"),pt(qt,"importScripts",t=>(function(...e){const n=e.map(J);return console.log("[lbview] importScripts:",n),Bt(t,this,n)}))}const Kt=p,{apply:Vt}=Reflect;function Yt(){console.log("page.init, begin: href: "+Kt.location.href+", docment.domain:"+Kt.document.domain+", origin: "+Kt.location.origin);const t=Kt.document,{location:e,navigator:n}=Kt,o=new URL(t.baseURI);u(o);const r=gt(Kt);Jt(),function(t){console.log("page.initDoc, begin: href: "+Kt.location.href+", docment.domain:"+Kt.document.domain+", origin: "+Kt.location.origin);const e=Kt.document,n=e.head,o=e.getElementsByTagName("base")[0];e.__baseElem=o;const r=new WeakSet;function s(e){if(r.has(e))return;r.add(e);const n=e.childNodes;for(let t=0,e=n.length;t<e;t++)s(n[t]);t.addNode(e)}function i(e){r.delete(e);const s=e.childNodes;for(let t=0,e=s.length;t<e;t++)i(s[t]);t.delNode(e),e===o&&(n.insertBefore(o,n.firstChild),console.warn("[lbview] base elem restored"))}new Kt.MutationObserver((function(t){t.forEach(t=>{t.addedNodes.forEach(s),t.removedNodes.forEach(i)})})).observe(e,{childList:!0,subtree:!0}),console.log("page.initDoc, end: href: "+Kt.location.href+", docment.domain:"+Kt.document.domain+", origin: "+Kt.location.origin)}(r);const s=n.serviceWorker,i=s.controller;function c(t,e){i&&i.postMessage([t,e])}i||console.log("page.init, sw.controller is null!, href: "+Kt.location.href+", docment.domain:"+Kt.document.domain+", origin: "+Kt.location.origin),function(){const e=t.currentScript;e&&(+e.dataset.id?c(y):console.warn("[lbview] missing page id"))}(),s.addEventListener("message",t=>{const[e,n]=t.data;switch(e){case v:n.forEach(Lt);break;case b:n.cookies.forEach(Lt),at(n.conf);break;case L:at(n)}t.stopImmediatePropagation()},!0),s.startMessages&&s.startMessages();const l=Kt.ServiceWorkerContainer.prototype;function h(t){pt(Kt.History.prototype,t,e=>(function(n,o,r){console.log("[lbview] history.%s: %s",t,r);let s=f();const i=B(r,s.href);if(i){if(s.origin!==i.origin)throw Error(`Failed to execute '${t}' on 'History': A history state object with URL '${r}' cannot be created in a document with origin '${s.origin}' and URL '${s.href}'.`);arguments[2]=G(i)}return Vt(e,this,arguments)}))}l&&(pt(l,"register",t=>(function(t){return console.warn("access serviceWorker.register blocked"),new Promise((function(){}))})),pt(l,"getRegistration",t=>(function(t){return console.warn("access serviceWorker.getRegistration blocked"),new Promise((function(){}))})),pt(l,"getRegistrations",t=>(function(){return console.warn("access serviceWorker.getRegistrations blocked"),new Promise((function(){}))}))),h("pushState"),h("replaceState"),pt(Kt,"open",t=>(function(e){return e&&(arguments[0]=J(e,e)),Vt(t,this,arguments)}));const p=Kt.Document.prototype;let g=o.hostname;function w(t){return function(){const e=t.call(this);return e&&V(e)}}dt(p,"domain",t=>(function(){return g}),t=>(function(n){console.log("[lbview] set document.domain:",n),g=n,t.call(this,e.hostname)})),dt(p,"cookie",t=>(function(){return Rt(f())}),t=>(function(t){const e=St(t,f(),Date.now());e&&(Lt(e),c(_,e))})),dt(p,"referrer",w),dt(p,"URL",w),dt(p,"documentURI",w),dt(Kt.Node.prototype,"baseURI",w);const k=Kt.MessageEvent.prototype;dt(k,"origin",t=>(function(){return f().origin}));const E=Kt.HTMLMetaElement.prototype;function x(t,e,n){r.attr(t,e,{name:n,onget(t){return null===t?"":function(t,e){let n;if(a())n=e;else{n=f().href}const o=B(t,n);return o?K(o):t}(t,this)},onset(t){return""===t?t:J(t,this)}})}r.attr("META",E,{name:"http-equiv",onget:t=>t,onset(t){let e;switch(t.toLowerCase()){case"refresh":(e=z(this.content,this))!==t&&(console.warn("[lbview] meta redir"),this.content=e);break;case"content-security-policy":console.warn("[lbview] meta csp removed"),this.remove();break;case"content-type":this.remove()}return t}},{name:"charset",onget:t=>t,onset:t=>"utf-8"});const S=Kt.HTMLAnchorElement.prototype;x("A",S,"href");const R=Kt.HTMLAreaElement.prototype;x("AREA",R,"href");const O=Kt.HTMLFormElement.prototype;x("FORM",O,"action");const P=Kt.HTMLScriptElement.prototype,j=Kt.HTMLLinkElement.prototype;"http:"===o.protocol&&(x("SCRIPT",P,"src"),x("LINK",j,"href")),x("IMG",Kt.HTMLImageElement.prototype,"src"),x("EMBED",Kt.HTMLEmbedElement.prototype,"src"),x("OBJECT",Kt.HTMLObjectElement.prototype,"data");const T=Kt.HTMLIFrameElement.prototype;x("IFRAME",T,"src"),x("FRAME",Kt.HTMLFrameElement.prototype,"src");const $=Kt.HTMLBaseElement.prototype;function N(t){function e(e){dt(t,e,t=>(function(){return new URL(this.href)[e]}),t=>(function(t){const n=new URL(this.href);n[e]=t,this.href=n.href}))}e("protocol"),e("hostname"),e("host"),e("port"),e("pathname"),e("origin")}r.attr("BASE",$,{name:"href",onget(t){return this.__href||t},onset(t){const e=this.ownerDocument.__baseElem;if(!e||e===this)return t;console.log("[lbview] baseURI updated:",t);const n=B(t,e.href);return e.href=n.href,this.__href=t,""}}),Kt.parent=m(Kt.parent),Kt.__ParentF=function(t){let e=Kt.parent;return e&&t===e?d(e):t},dt(T,"contentWindow",t=>(function(){return m(t.call(this))})),dt(k,"source",t=>(function(){return m(t.call(this))})),N(S),N(R),pt(O,"submit",t=>(function(){return this.action=this.action,Vt(t,this,arguments)})),pt(Kt.HTMLElement.prototype,"click",t=>(function(){let e=this;if(!e.isConnected){for(;e;){const t=e.tagName;if("A"===t||"AREA"===t){e.href=e.href;break}e=e.parentNode}return Vt(t,this,arguments)}}));new WeakMap;const D=new WeakMap;r.attr("SCRIPT",P,{name:"charset",onget(t){return D.get(this)||t},onset(t){return/^utf-?8$/i.test(t)||(t="utf-8"),D.set(this,t),t}},{name:"innerText",onget:t=>t,onset(t,e){const n=I(this,t);return null===n?e?ht:t:n}}),dt(P,"text",t=>(function(){return t.call(this)}),t=>(function(e){const n=I(this,e);null===n?t.call(this,e):t.call(this,n)}));const A=new WeakSet;function I(t,e){const n=t.type;return n&&(o=n,!M.has(o))?null:A.has(t)?null:(A.add(t),Tt(e));var o}function W(e){const n=new WeakSet;t.addEventListener(e.substr(2),t=>{!function t(o){if(!n.has(o)&&(n.add(o),1==o.nodeType)){if(o[e]){const t=o.getAttribute(e);if(t){const n=Tt(t);n&&(o[e]=n,console.log("[lbview] hookEvent onevent:",e))}}t(o.parentNode)}}(t.target)},!0)}W("onerror"),W("onload"),W("onclick"),console.log("page.init, end: href: "+Kt.location.href+", docment.domain:"+Kt.document.domain+", origin: "+Kt.location.origin)}let zt,Xt,Qt=new Set;async function Zt(t){const e=t.assets_cdn+t.direct_host_list,n=await fetch(e);let o=await n.text();o=o.replace(/\r/g,"");for(const t of o.split("\n"))t&&"#"!==t[0]&&Qt.add(t)}function te(t){return Qt.has(t)}async function ee(t){try{const e=await fetch(t,{referrerPolicy:"no-referrer"}),{status:n}=e;if(200===n||206===n)return e;console.warn("direct status:",n,t)}catch(e){console.warn("direct fail:",t)}}function ne(t){Xt=t,function(t){Promise.all([Zt(t)])}(t)}function oe(t){return zt||console.log("error"),zt.get("url-cache",t)}async function re(t,e,n){await zt.put("url-cache",{url:t,host:e,expires:n})}async function se(t,e){let n=t.method;const o={method:n,mode:"cors",credentials:"same-origin",headers:new Headers(t.headers),referrerPolicy:"unsafe-url",referrer:"/?"+new URLSearchParams(e)};if("HEAD"!==(n=n.toUpperCase())&&"GET"!==n){const e=await t.arrayBuffer();e.byteLength>0&&(o.body=e)}return o.headers.delete("origin"),o}const ie=5;async function ce(t,e){if(!q(e.protocol)){return console.log("is not Http Proto! "+e.href),{res:await fetch(t)}}const{method:n}=t,o=e.href,r=j(o);let s="";const{reqMap:i}=function(t,e){const n={};return t.referrer&&(n.referer=e.origin+"/"),n.cookie=Rt(e),{reqMap:n}}(t,e);for(;"GET"===n;){const t=await oe(o);if(t&&t.host){if(T()<t.expires){s=t.host;break}}if(te(e.host)){console.log("direct hit:",o);const t=await ee(o);if(t)return re(o,"",""),{res:t}}break}let c,a,l=1;s&&(l=0);for(let n=0;n<ie;n++){0===n&&s||(s=it(r,l));const o=Y(e.href);let u=st(s,"http")+"/"+o;c=null;try{i["--level"]=l;let e=new Request(u,await se(t,i));c=await fetch(e)}catch(t){console.warn("fetch fail:"+t+", "+u);break}if((a=c.headers).has("--switched")){l++;continue}const f=a.get("--error");if(!f)break;console.warn("[lbview] cfworker fail:",f),l=0}if(!c)return;const{status:u,headers:f,cookieStrArr:h}=function(t){const e=t.headers;let n=t.status;const o=[],r=new Headers;return e.forEach((t,e)=>{if("access-control-allow-origin"===e||"access-control-expose-headers"===e||"x-frame-options"===e||"content-security-policy"===e||"content-security-policy-report-only"===e||"clear-site-data"===e)return;if("--s"===e)return void(n=+t);const s=e.match(/^\d+-(.+)/);s?"set-cookie"===(e=s[1])?o.push(t):r.append(e,t):(e.startsWith("--")&&(e=e.substr(2)),"set-cookie"!==e?r.set(e,t):o.push(t))}),{status:n,headers:r,cookieStrArr:o}}(c);if("GET"===n&&200===u){const t=function(t){const e=t.get("cache-control");if(e){if(/no-cache/i.test(e))return-1;const t=e.match(/(?:^|,\s*)max-age=["]?(\d+)/i);if(t){const e=+t[1];if(e>0)return e}}const n=t.get("expires");if(n){const t=Date.parse(n);if(t>0)return(t-Date.now())/1e3|0}return 0}(f);if(t>=0){re(o,s,T()+t+1e3)}}const p=f.get("refresh");if(p){const t=z(p,o);t!==p&&(console.log("[lbview] http refresh:",p),f.set("refresh",t))}let d;if(h.length){const t=function(t,e){const n=[],o=Date.now();for(const r of t){const t=St(r,e,o);t&&(Lt(t),t.httpOnly||n.push(t))}return n}(h,e);t.length&&(d=t)}return{res:c,status:u,headers:f,cookies:d}}const ae=p,le=ae.clients,ue=3e5;let fe;const he=5;let pe;function de(t,e,n){t?t.postMessage([e,n]):console.warn("invalid target",e,n)}let ge=0;function we(t,e=200){return new Response(t,{status:e,headers:{"content-type":"text/html; charset=utf-8"}})}async function me(t,e,n){const o=await le.matchAll({type:"window"});for(const r of o)"top-level"===r.frameType&&(n&&r.id===n||de(r,t,e))}const ye=new Map;async function be(t,e,n,o){const r=await ce(t,e);if(!r)return we("load fail");let{res:s,status:i,headers:c,cookies:a}=r;a&&me(v,a),i||(i=s.status||200);let l=!0;c||(c=s.headers,l=!1);const u=(t,e)=>{l||(c=new Headers(c),l=!0),c.set(t,e)},f=c.get("gateway-err--");if(f)return function(t,e,n){let o="";const{msg:r,addr:s,url:i}=JSON.parse(t);switch(e){case 204:switch(r){case"ORIGIN_NOT_ALLOWED":o="当前域名不在服务器外链白名单";break;case"CIRCULAR_DEPENDENCY":o="当前请求出现循环代理";break;case"SITE_MOVE":o=`当前站点移动到: <a href="${i}">${i}</a>`}break;case 500:o="代理服务器内部错误";break;case 502:o=s?`代理服务器无法连接网站 ${n.origin} (${s})`:`代理服务器无法解析域名 ${n.host}`;break;case 504:o=`代理服务器连接网站超时 ${n.origin}`,s&&(o+=` (${s})`)}return we(o)}(f,i,e);const h={status:i,headers:c};if(101===i||204===i||205===i||304===i)return new Response(null,h);if(301===i||302===i||303===i||307===i||308===i){const r=c.get("location"),s=r&&B(r,e);if(s){if("follow"===t.redirect)return++o===he?we("重定向过多",500):be(t,s,n,o);u("location",G(s))}return new Response(null,h)}const p=c.get("content-type")||"",[,d,g]=p.toLocaleLowerCase().match(/([^;]*)(?:.*?charset=['"]?([^'"]+))?/),w=t.destination;if("script"===w||"worker"===w||"sharedworker"===w){let t=function(t,e){return`if (typeof importScripts === 'function' && !self.window && !self.__PATH__) {\n  self.__PATH__ = '${$}';\n  importScripts('${I}');\n}\n`+Tt(t,e.href)}(await s.text(),e);return u("content-type","text/javascript"),new Response(t,h)}if("navigate"===t.mode&&"text/html"===d){let t=$t(await s.text(),e,++ge);return u("content-type","text/html; charset=utf-8"),new Response(t,h)}return new Response(s.body,h)}async function _e(t,e){const n=t.clientId;let o;n&&(o=ye.get(n)||await async function(t){const e=await le.get(t);if(!e)return;const n=V(e.url);return ye.set(t,n),n}(n)),o||(o=e.href);const r=new URL(o);try{return await be(t.request,e,r,0)}catch(t){return console.error(t),we("前端脚本错误<br><pre>"+t.stack+"</pre>",500)}}let ve,ke;async function Ee(){ve=new mt(".sys"),await ve.open({"url-cache":{keyPath:"url"},cookie:{keyPath:"id"}}),await async function(t){zt=t}(ve),await async function(t){Ot=t;const e=Date.now();await Ot.enum("cookie",t=>(_t(t,e)?Ot.delete("cookie",t.id):Lt(t),!0)),setInterval(Mt,3e3)}(ve)}function xe(t,e){if(!e&&fe){if(t.ver<=fe.ver)return;t.node_map[fe.node_default]?t.node_default=fe.node_default:console.warn("default node %s -> %s",fe.node_default,t.node_default),me(L,fe)}!function(t){Pt=t}(t),at(t),ne(t),pe=function(t){const e={};if(!t)return e;for(const[n,o]of Object.entries(t))e[n]=o;return e}(t.url_handler),async function(t){const e=JSON.stringify(t),n=await caches.open(".sys"),o=new Request("/conf.json"),r=new Response(e);n.put(o,r)}(t),fe=t}async function Se(){const t=await fetch("conf.js"),e=await t.text();ae.lbview_config=xe,Function(e)()}async function Le(){if(ke){const t=new wt;return ke.push(t),t.wait()}let t;ke=[];try{t=await async function(){const t=await caches.open(".sys"),e=new Request("/conf.json"),n=await t.match(e);if(n)return n.json()}()}catch(t){console.warn("load conf fail:",t)}t||(t=ae.__CONF__),t?xe(t):t=await Se(),setInterval(Se,ue),ke.forEach(t=>t.notify()),ke=null}function Re(){console.log("sw.init begin. url: "+ae.location.href),ae.addEventListener("fetch",t=>{t.respondWith(async function(t){fe||await Le(),ve||await Ee();const e=t.request,n=Y(e.url);if(n===$||n===N){let t=fe.assets_cdn+fe.index_path;return fe.index_path||(t=fe.assets_cdn+"index_v3.html"),we((await fetch(t)).body)}if(n===D||n===A)return fetch(n);if(n===I)return fetch(ae.__FILE__);if(n.startsWith(W)){const t=n.substr(W.length);return fetch(fe.assets_cdn+t)}if(n.startsWith($)&&-1===n.indexOf(C))return fetch(n);if("navigate"===e.mode){const t=ot(n);if(t)return Response.redirect(t,301)}let o=V(n);const r=pe[o];if(r){const{redir:t,content:e,replace:n}=r;if(t)return Response.redirect("/-----"+t);if(e)return we(e);n&&(o=n)}const s=B(o);return s?_e(t,s):we("invalid url: "+o,500)}(t))}),ae.addEventListener("message",t=>{const[e,n]=t.data,o=t.source;switch(e){case _:Lt(n),me(v,[n],o.id);break;case y:de(o,b,{cookies:xt(),conf:fe});break;case E:fe?de(o,S,fe):Le().then(t=>{de(o,S,fe)});break;case k:xe(n,!0),me(L,fe);break;case x:Se();break;case R:de(o,O),Se()}}),ae.addEventListener("install",t=>{console.log("oninstall:",t),t.waitUntil(ae.skipWaiting())}),ae.addEventListener("activate",t=>{console.log("onactivate:",t),me(O,1),t.waitUntil(le.claim())}),console.log("sw.init end. url: "+ae.location.href)}console.log("env.init, global name: "+p.constructor.name+" href:"+p.location.href),(c="onclick"in p?o:"onfetch"in p?s:r)===o?Yt():a()?Re():l()&&Jt()}]);